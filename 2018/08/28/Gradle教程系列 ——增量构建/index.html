<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="何夜无月，何处无竹柏，但少闲人，如吾两人者耳"><title>Gradle教程系列 ——增量构建 | 学而时习之</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Gradle教程系列 ——增量构建</h1><a id="logo" href="/.">学而时习之</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Gradle教程系列 ——增量构建</h1><div class="post-meta">Aug 28, 2018<span> | </span><span class="category"><a href="/categories/Gradle教程/">Gradle教程</a></span></div><div class="post-content"><p>内置任务（如JavaCompile）声明了输入集合（Java源文件）和输出集合（class文件）。Gradle使用此信息来确定任务是否是最新的并且是否需要执行任何工作。如果没有任何输入或输出发生更改，Gradle可以跳过该任务。总之，我们将这种行为成为<strong>Gradle增量构建</strong>。</p>
<p>为了利用增量构建支持，我们需要向Gradle提供有关任务的输入和输出的信息。也可以将任务配置为只有输出。在执行这个任务之前，Gradle会检查输出，如果输出结果没有改变，则跳过这个任务。在实际的构建过程中，任务通常也有输入 - 包括源文件，资源和属性。Gradle在执行任务之前，会检查任务的输入和输出有没有改变。</p>
<p>通常一个任务的输出是作为另一个任务的输入。获得任务之间的执行顺序是至关重要的。Gradle不依赖于在构建脚本中定义任务的顺序，而是通过dependsOn定义任务的依赖关系，明确告诉Gradle两个任务之间的执行顺序。</p>
<h2 id="声明任务依赖"><a href="#声明任务依赖" class="headerlink" title="声明任务依赖"></a>声明任务依赖</h2><p>在这一节，我们看一个简单的例子。在这个项目中，我们需要创建一个zip文件。generator任务创建文件的方式并不重要 - 它生成包含递增数字的文件。</p>
<p>build.gradle</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'base'</span></span><br><span class="line"></span><br><span class="line">task generator() &#123;</span><br><span class="line">    doLast &#123;</span><br><span class="line">        <span class="keyword">def</span> generatedFileDir = file(<span class="string">"$buildDir/generated"</span>)</span><br><span class="line">        generatedFileDir.mkdirs()</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> File(generatedFileDir, <span class="string">"$&#123;i&#125;.txt"</span>).text = i</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task zip(<span class="string">type:</span> Zip) &#123;</span><br><span class="line">    dependsOn generator</span><br><span class="line">    from <span class="string">"$buildDir/generated"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个脚本是可以工作的，但是它还有一些问题。zip任务中重复<code>generator</code>任务的输出目录，并使用dependsOn显式设置zip任务的依赖关系。Gradle似乎每次都执行<code>generator</code>任务，但不执行zip任务。现在是时候指出Gradle的最新检查与其他工具不同，例如Make。即Gradle会比较输入和输出的校验和，而不仅仅是文件的时间戳。虽然每次运行<code>generator</code>任务并覆盖其所有输出文件，但内容不会更改，并且zip任务不需要再次运行。zip任务输入的校验和没有改变。跳过最新任务可让Gradle避免不必要的工作，从而加快构建速度。</p>
<h2 id="声明任务的输入和输出"><a href="#声明任务的输入和输出" class="headerlink" title="声明任务的输入和输出"></a>声明任务的输入和输出</h2><p>现在，让我们看一下为什么<code>generator</code>任务每次都会执行。我们可以通过添加<code>--info</code>参数查看原因。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">It is not up-to-date <span class="string">because:</span>Task has not declared any outputs.</span><br></pre></td></tr></table></figure>
<p>我们从打印的信息可以看到，Gradle不知道任务产生任何输出。默认情况下，如果一个任务没有任何输出，它会被认为是out-of-date。任务的输出可以使用TaskOutputs声明。任务的输出可以是文件也可以是输出。<code>outputs</code>使用如下所示：</p>
<p>build.gradle</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">task generator() &#123;</span><br><span class="line">    <span class="keyword">def</span> generatedFileDir = file(<span class="string">"$buildDir/generated"</span>)</span><br><span class="line">    outputs.dir generatedFileDir</span><br><span class="line">    doLast &#123;</span><br><span class="line">        generatedFileDir.mkdirs()</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> File(generatedFileDir, <span class="string">"$&#123;i&#125;.txt"</span>).text = i</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们连续运行两次修改后的任务，我们可以看到，在第二次运行后的信息是：<code>generator</code>任务是up-to-date（最新的）。我们在运行时添加<code>--info</code>参数，可以看到如下信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Skipping task &apos;:generator&apos; as it is up-to-date (took 0.001 secs).</span><br></pre></td></tr></table></figure>
<p>当任务的输入和输出都没有改变时，Gradle会跳过这个任务。在大型项目中，可以节省很多的项目构建时间。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>增量构建是通过检验输入和输出是否发生更改，确定是否跳过该任务的执行，从而加快构建速度。在编写Gradle脚本时，我们可以善于利用Gradle增量构建的概念，声明任务的输入和输出，进一步提高项目的构建速度。</p>
</div><div class="tags"><a href="/tags/Gradle/">Gradle</a></div><div class="post-nav"><a class="pre" href="/2018/08/28/Gradle教程系列 ——构建生命周期/">Gradle教程系列 —— Gradle 构建声明周期</a><a class="next" href="/2018/06/07/Java 反射机制/">Java 反射机制</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://nxiangbo.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/命令行工具/">命令行工具</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/Android/">Android</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle-教程/">Gradle 教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle教程/">Gradle教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/语法/" style="font-size: 15px;">语法</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/UI/" style="font-size: 15px;">UI</a> <a href="/tags/适配/" style="font-size: 15px;">适配</a> <a href="/tags/strictmode/" style="font-size: 15px;">strictmode</a> <a href="/tags/Gradle/" style="font-size: 15px;">Gradle</a> <a href="/tags/task/" style="font-size: 15px;">task</a> <a href="/tags/性能优化/" style="font-size: 15px;">性能优化</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/反射/" style="font-size: 15px;">反射</a> <a href="/tags/Java虚拟机/" style="font-size: 15px;">Java虚拟机</a> <a href="/tags/内存模型/" style="font-size: 15px;">内存模型</a> <a href="/tags/资源打包/" style="font-size: 15px;">资源打包</a> <a href="/tags/aapt2/" style="font-size: 15px;">aapt2</a> <a href="/tags/Gradle-插件/" style="font-size: 15px;">Gradle 插件</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/06/aapt2 工具介绍/">aapt2 工具介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Android Gradle Plugin 源码分析(一)/">Android Gradle Plugin 源码分析(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Gradle教程系列 ——基本语法/">Gradle教程系列 ——基本语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Gradle教程系列 ——Project和Task/">Gradle教程系列 —— Project 和 Task</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/03/Gradle教程系列 ——文件操作/">Gradle教程系列 ——文件操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/28/Gradle教程系列 ——构建生命周期/">Gradle教程系列 —— Gradle 构建声明周期</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/28/Gradle教程系列 ——增量构建/">Gradle教程系列 ——增量构建</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/07/Java 反射机制/">Java 反射机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/05/Android 屏幕适配/">Android 屏幕适配</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/25/Java类加载机制/">Java类加载机制</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">学而时习之.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>